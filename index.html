<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è’‹ä¸€å‡¡ä¸“å±é¡µé¢ | ç»ˆææ•‘æ´ç‰ˆ</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #000;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    touch-action: manipulation;
    font-family: "Microsoft YaHei", sans-serif;
  }
  #particles-js { position: fixed; width: 100%; height: 100%; z-index: 0; }
  .audio-wave {
    width: 260px;
    height: 260px;
    border-radius: 50%;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: breathe 3s ease-in-out infinite;
    z-index: 1;
  }
  .audio-wave.active { animation: pulse 0.5s ease infinite alternate; }
  @keyframes breathe {
    0%, 100% { box-shadow: 0 0 0 5px rgba(255, 51, 51, 0.3); }
    50% { box-shadow: 0 0 0 20px rgba(255, 51, 51, 0.2); }
  }
  @keyframes pulse {
    0% { transform: scale(1); opacity: 0.8; }
    100% { transform: scale(1.1); opacity: 1; }
  }
  .avatar {
    width: 220px;
    height: 220px;
    border-radius: 50%;
    border: 5px solid #ff3333;
    object-fit: cover;
    position: absolute;
    z-index: 2;
    animation: rotate 20s linear infinite;
    cursor: pointer;
  }
  @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  .play-btn {
    margin-top: 40px;
    padding: 12px 30px;
    font-size: 18px;
    background: #ff3333;
    color: #fff;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    box-shadow: 0 0 15px #ff3333;
    transition: 0.3s;
    z-index: 3;
    position: relative;
    -webkit-tap-highlight-color: transparent;
  }
  .play-btn:hover { background: #ff6666; transform: scale(1.05); }
  .music-switch-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #333;
    color: #fff;
    border: 2px solid #ff3333;
    font-size: 20px;
    cursor: pointer;
    transition: 0.3s;
    z-index: 3;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
  }
  .music-switch-btn:hover {
    background: #ff3333;
    transform: scale(1.1);
  }
  .music-control-group {
    display: flex;
    align-items: center;
    gap: 15px;
  }
  .music-name {
    color: #fff;
    margin-top: 15px;
    font-size: 16px;
    z-index: 3;
    position: relative;
    text-align: center;
    max-width: 80%;
  }

  /* ç´§æ€¥å¤‡ç”¨è¾“å…¥æ¡†æ ·å¼ */
  #emergencyBox {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: #333;
    color: #fff;
    padding: 10px;
    z-index: 9999;
    display: none; /* é»˜è®¤éšè— */
  }
  #emergencyBox textarea {
    width: 100%;
    height: 80px;
    background: #444;
    color: #eee;
    border: 1px solid #ff3333;
    margin: 5px 0;
    padding: 5px;
    font-size: 12px;
  }
</style>
</head>
<body>
  <!-- ç´§æ€¥å¤‡ç”¨æ–¹æ¡ˆï¼šå¦‚æœè‡ªåŠ¨åŠ è½½å¤±è´¥ï¼Œè¿™é‡Œä¼šæ˜¾ç¤º -->
  <div id="emergencyBox">
    <strong>âš ï¸ è‡ªåŠ¨åŠ è½½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´ music.json å†…å®¹ï¼š</strong>
    <textarea id="jsonInput" placeholder="è¯·æŠŠ https://13413.kstore.vip/QingMusic/music.json æ‰“å¼€åçš„å†…å®¹å¤åˆ¶ç²˜è´´åˆ°è¿™é‡Œ..."></textarea>
    <button onclick="loadFromText()">æ‰‹åŠ¨åŠ è½½</button>
  </div>

  <div id="particles-js"></div>
  <div class="audio-wave" id="wave">
    <img src="avatar.jpg" alt="è’‹ä¸€å‡¡å¤´åƒ" class="avatar" id="avatar">
  </div>
  <div class="music-control-group">
    <button class="music-switch-btn" onclick="switchMusic('prev')">â†</button>
    <button class="play-btn" onclick="toggleMusic()" id="btn">å°è¯•åŠ è½½æ­Œå•...</button>
    <button class="music-switch-btn" onclick="switchMusic('next')">â†’</button>
  </div>
  <div class="music-name" id="musicName">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>

  <audio id="bgm" preload="auto">
    <source src="" type="audio/mpeg" id="audioSource">
    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
  

  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <script>
    // --- ç²’å­ç‰¹æ•ˆåˆå§‹åŒ– ---
    particlesJS("particles-js", {
      "particles": {
        "number": { "value": 80, "density": { "enable": true, "value_area": 800 } },
        "color": { "value": "#ff3333" },
        "shape": { "type": "circle" },
        "opacity": { "value": 0.5, "random": true },
        "size": { "value": 3, "random": true },
        "line_linked": {
          "enable": true, "distance": 150, "color": "#ff3333", "opacity": 0.2, "width": 1
        },
        "move": { "enable": true, "speed": 1, "direction": "none", "random": true }
      },
      "interactivity": {
        "detect_on": "canvas",
        "events": { "onhover": { "enable": true, "mode": "grab" }, "onclick": { "enable": true, "mode": "push" } }
      },
      "retina_detect": true
    });

    // --- å…¨å±€å˜é‡ ---
    const audio = document.getElementById('bgm');
    const audioSource = document.getElementById('audioSource');
    const btn = document.getElementById('btn');
    const wave = document.getElementById('wave');
    const musicNameEl = document.getElementById('musicName');
    const avatarEl = document.getElementById('avatar');
    const emergencyBox = document.getElementById('emergencyBox');
    const jsonInput = document.getElementById('jsonInput');
    
    let musicList = [];
    let currentMusicIndex = 0;
    let isPlaying = false;
    let animationId;

    // --- 1. æ ¸å¿ƒåŠ è½½é€»è¾‘ï¼šä½¿ç”¨ CORS ä»£ç†è§£å†³è·¨åŸŸ ---
    const originalUrl = "https://13413.kstore.vip/QingMusic/music.json";
    // ä½¿ç”¨ä»£ç†æœåŠ¡å™¨å‰ç¼€
    const proxyUrl = "https://cors-anywhere.herokuapp.com/";
    const fetchUrl = proxyUrl + originalUrl;

    // æ–¹æ¡ˆAï¼šå°è¯•é€šè¿‡ä»£ç†è‡ªåŠ¨åŠ è½½
    fetch(fetchUrl)
      .then(response => {
        if (!response.ok) throw new Error("ä»£ç†æœåŠ¡å™¨å“åº”å¼‚å¸¸");
        return response.json();
      })
      .then(data => {
        handleLoadedData(data);
      })
      .catch(error => {
        console.error("è‡ªåŠ¨åŠ è½½å¤±è´¥ï¼ŒåŸå› ï¼š", error);
        // å¦‚æœè‡ªåŠ¨åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥æ¡†
        btn.innerText = "åŠ è½½å¤±è´¥ âŒ";
        musicNameEl.innerText = "è¯·ä½¿ç”¨ä¸Šæ–¹æ‰‹åŠ¨è¾“å…¥åŠŸèƒ½";
        emergencyBox.style.display = "block"; // æ˜¾ç¤ºå¤‡ç”¨æ–¹æ¡ˆ
      });

    // --- 2. æ–¹æ¡ˆBï¼šæ‰‹åŠ¨ç²˜è´´ JSON åŠ è½½ï¼ˆä¿åº•æ–¹æ¡ˆï¼‰ ---
    function loadFromText() {
      try {
        const jsonText = jsonInput.value.trim();
        if (!jsonText) {
          alert("è¯·å…ˆç²˜è´´å†…å®¹ï¼");
          return;
        }
        const data = JSON.parse(jsonText);
        handleLoadedData(data);
        emergencyBox.style.display = "none"; // éšè—è¾“å…¥æ¡†
        alert("æ‰‹åŠ¨åŠ è½½æˆåŠŸï¼");
      } catch (e) {
        alert("ç²˜è´´çš„å†…å®¹æ ¼å¼ä¸å¯¹ï¼Œè¯·æ£€æŸ¥æ˜¯å¦æ˜¯å®Œæ•´çš„ JSONã€‚");
        console.error(e);
      }
    }

    // --- 3. å¤„ç†åŠ è½½å¥½çš„éŸ³ä¹æ•°æ® ---
    function handleLoadedData(data) {
      // å…¼å®¹å¸¸è§çš„ JSON æ ¼å¼
      if (data.list && data.list.length > 0) {
        musicList = data.list;
      } else if (Array.isArray(data) && data.length > 0) {
        // å¦‚æœ JSON ç›´æ¥æ˜¯æ•°ç»„
        musicList = data;
      } else {
        throw new Error("æ•°æ®æ ¼å¼ä¸è¯†åˆ«");
      }

      // åˆå§‹åŒ–ç¬¬ä¸€é¦–
      loadMusic(0);
      btn.innerText = `ç‚¹å‡»æ’­æ”¾ ${musicList[0].name || musicList[0].title}`;
    }

    // --- 4. åŠ è½½æŒ‡å®šéŸ³ä¹ ---
    function loadMusic(index) {
      if (!musicList.length) return;
      
      const song = musicList[index];
      // å…¼å®¹ name/title å’Œ url/path å­—æ®µ
      audioSource.src = song.url || song.path;
      audio.load();
      musicNameEl.innerText = `å½“å‰æ›²ç›®ï¼š${song.name || song.title || 'æœªçŸ¥æ­Œæ›²'}`;
    }

    // --- 5. æ’­æ”¾æ§åˆ¶ ---
    function toggleMusic() {
      if (!musicList.length) {
        alert("æ­Œå•ä¸ºç©ºï¼");
        return;
      }

      if (isPlaying) {
        audio.pause();
        btn.innerText = `ç‚¹å‡»æ’­æ”¾ ${musicList[currentMusicIndex].name || musicList[currentMusicIndex].title}`;
        wave.classList.remove('active');
        cancelAnimationFrame(animationId);
      } else {
        audio.play().then(() => {
          btn.innerText = `æ­£åœ¨æ’­æ”¾... (ç‚¹å‡»æš‚åœ)`;
          wave.classList.add('active');
          simulateWave();
        }).catch(err => {
          btn.innerText = "ç‚¹å‡»å±å¹•ä»»æ„å¤„è§£é”";
          document.body.addEventListener('click', () => audio.play().then(startPlaying), { once: true });
        });
      }
      isPlaying = !isPlaying;
    }

    function startPlaying() {
      btn.innerText = `æ­£åœ¨æ’­æ”¾... (ç‚¹å‡»æš‚åœ)`;
      wave.classList.add('active');
      simulateWave();
    }

    // --- 6. åˆ‡æ¢æ­Œæ›² ---
    function switchMusic(type) {
      if (!musicList.length) return;

      if (isPlaying) {
        audio.pause();
        wave.classList.remove('active');
        cancelAnimationFrame(animationId);
        isPlaying = false;
      }

      currentMusicIndex = type === 'prev' 
        ? (currentMusicIndex - 1 + musicList.length) % musicList.length
        : (currentMusicIndex + 1) % musicList.length;
      
      loadMusic(currentMusicIndex);
      btn.innerText = `ç‚¹å‡»æ’­æ”¾ ${musicList[currentMusicIndex].name || musicList[currentMusicIndex].title}`;
    }

    // --- 7. åŠ¨ç”»ä¸å½©è›‹ ---
    function simulateWave() {
      if (!isPlaying) return;
      const size = Math.random() * 15 + 10;
      wave.style.boxShadow = `0 0 0 ${size}px rgba(255, 51, 51, 0.5)`;
      animationId = requestAnimationFrame(simulateWave);
    }

    avatarEl.onclick = function() {
      const tip = document.createElement('div');
      tip.innerText = 'ğŸ˜‹ å°å“¥å“¥';
      tip.style.cssText = `position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:30px;color:#ff3333;z-index:999;animation:fade 2s ease-out;`;
      document.body.appendChild(tip);
      setTimeout(() => document.body.removeChild(tip), 2000);
    };
  </script>
</body>
</html>
