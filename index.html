<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è’‹ä¸€å‡¡ä¸“å±é¡µé¢ | ç»ˆæå®Œæ•´ç‰ˆ</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #000;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    touch-action: manipulation;
    font-family: "Microsoft YaHei", sans-serif;
  }
  #particles-js { position: fixed; width: 100%; height: 100%; z-index: 0; }
  .audio-wave {
    width: 260px;
    height: 260px;
    border-radius: 50%;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: breathe 3s ease-in-out infinite;
    z-index: 1;
  }
  .audio-wave.active { animation: pulse 0.5s ease infinite alternate; }
  @keyframes breathe {
    0%, 100% { box-shadow: 0 0 0 5px rgba(255, 51, 51, 0.3); }
    50% { box-shadow: 0 0 0 20px rgba(255, 51, 51, 0.2); }
  }
  @keyframes pulse {
    0% { transform: scale(1); opacity: 0.8; }
    100% { transform: scale(1.1); opacity: 1; }
  }
  .avatar {
    width: 220px;
    height: 220px;
    border-radius: 50%;
    border: 5px solid #ff3333;
    object-fit: cover;
    position: absolute;
    z-index: 2;
    animation: rotate 20s linear infinite;
    cursor: pointer;
  }
  @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  .play-btn {
    margin-top: 40px;
    padding: 12px 30px;
    font-size: 18px;
    background: #ff3333;
    color: #fff;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    box-shadow: 0 0 15px #ff3333;
    transition: 0.3s;
    z-index: 3;
    position: relative;
    -webkit-tap-highlight-color: transparent;
  }
  .play-btn:hover { background: #ff6666; transform: scale(1.05); }
  .music-switch-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #333;
    color: #fff;
    border: 2px solid #ff3333;
    font-size: 20px;
    cursor: pointer;
    transition: 0.3s;
    z-index: 3;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
  }
  .music-switch-btn:hover {
    background: #ff3333;
    transform: scale(1.1);
  }
  .music-control-group {
    display: flex;
    align-items: center;
    gap: 15px;
  }
  .music-name {
    color: #fff;
    margin-top: 15px;
    font-size: 16px;
    z-index: 3;
    position: relative;
    text-align: center;
    max-width: 80%;
  }

  /* ç´§æ€¥å¤‡ç”¨è¾“å…¥æ¡†æ ·å¼ (è§£å†³åŠ è½½æ…¢/è·¨åŸŸé—®é¢˜) */
  #emergencyBox {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: #333;
    color: #fff;
    padding: 10px;
    z-index: 9999;
    display: none; /* é»˜è®¤éšè— */
  }
  #emergencyBox textarea {
    width: 100%;
    height: 80px;
    background: #444;
    color: #eee;
    border: 1px solid #ff3333;
    margin: 5px 0;
    padding: 5px;
    font-size: 12px;
  }

  /* ====== æœç´¢åŠŸèƒ½æ ·å¼ (å®Œæ•´ä¿ç•™) ====== */
  .search-container {
    position: fixed;
    bottom: 20px;
    left: 0;
    width: 100%;
    padding: 0 20px;
    z-index: 10;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  #searchInput {
    width: 100%;
    max-width: 400px;
    padding: 12px 20px;
    border-radius: 50px;
    border: 2px solid #ff3333;
    background: rgba(0, 0, 0, 0.8);
    color: #fff;
    font-size: 16px;
    outline: none;
    box-shadow: 0 0 10px rgba(255, 51, 51, 0.5);
  }
  #searchInput::placeholder {
    color: #999;
  }
  /* æœç´¢ç»“æœåˆ—è¡¨ */
  .search-results {
    margin-top: 10px;
    width: 100%;
    max-width: 400px;
    max-height: 0;
    overflow-y: auto;
    background: rgba(0, 0, 0, 0.95);
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(255, 51, 51, 0.3);
    transition: max-height 0.3s ease;
  }
  .search-results.show {
    max-height: 200px; /* å±•å¼€é«˜åº¦ */
    border: 1px solid #333;
  }
  .result-item {
    padding: 10px 20px;
    color: #fff;
    cursor: pointer;
    border-bottom: 1px solid #222;
  }
  .result-item:hover {
    background: #ff3333;
  }
  /* å…³é”®è¯é«˜äº® */
  .highlight {
    color: #ff3333;
    font-weight: bold;
  }
</style>
</head>
<body>
  <!-- ç´§æ€¥å¤‡ç”¨æ–¹æ¡ˆ (åŠ è½½æ…¢æ—¶æ‰‹åŠ¨ç”¨) -->
  <div id="emergencyBox">
    <strong>âš ï¸ è‡ªåŠ¨åŠ è½½æ…¢ï¼Ÿæ‰‹åŠ¨ç²˜è´´æœ€å¿«ï¼š</strong>
    <textarea id="jsonInput" placeholder="è¯·æŠŠ https://13413.kstore.vip/QingMusic/music.json æ‰“å¼€åçš„å†…å®¹å¤åˆ¶ç²˜è´´åˆ°è¿™é‡Œ..."></textarea>
    <button onclick="loadFromText()">æ‰‹åŠ¨åŠ è½½</button>
  </div>

  <div id="particles-js"></div>
  <div class="audio-wave" id="wave">
    <img src="avatar.jpg" alt="è’‹ä¸€å‡¡å¤´åƒ" class="avatar" id="avatar">
  </div>
  <div class="music-control-group">
    <button class="music-switch-btn" onclick="switchMusic('prev')">â†</button>
    <button class="play-btn" onclick="toggleMusic()" id="btn">å°è¯•åŠ è½½æ­Œå•...</button>
    <button class="music-switch-btn" onclick="switchMusic('next')">â†’</button>
  </div>
  <div class="music-name" id="musicName">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>

  <!-- ====== æœç´¢åŠŸèƒ½ DOM (å®Œæ•´ä¿ç•™) ====== -->
  <div class="search-container">
    <input type="text" id="searchInput" placeholder="æœç´¢æ­Œæ›²...">
    <div class="search-results" id="searchResults"></div>
  </div>

  <audio id="bgm" preload="metadata">
    <source src="" type="audio/mpeg" id="audioSource">
    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
  

  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <script>
    // --- ç²’å­ç‰¹æ•ˆåˆå§‹åŒ– ---
    particlesJS("particles-js", {
      "particles": {
        "number": { "value": 80, "density": { "enable": true, "value_area": 800 } },
        "color": { "value": "#ff3333" },
        "shape": { "type": "circle" },
        "opacity": { "value": 0.5, "random": true },
        "size": { "value": 3, "random": true },
        "line_linked": {
          "enable": true, "distance": 150, "color": "#ff3333", "opacity": 0.2, "width": 1
        },
        "move": { "enable": true, "speed": 1, "direction": "none", "random": true }
      },
      "interactivity": {
        "detect_on": "canvas",
        "events": { "onhover": { "enable": true, "mode": "grab" }, "onclick": { "enable": true, "mode": "push" } }
      },
      "retina_detect": true
    });

    // --- å…¨å±€å˜é‡ ---
    const audio = document.getElementById('bgm');
    const audioSource = document.getElementById('audioSource');
    const btn = document.getElementById('btn');
    const wave = document.getElementById('wave');
    const musicNameEl = document.getElementById('musicName');
    const avatarEl = document.getElementById('avatar');
    const emergencyBox = document.getElementById('emergencyBox');
    const jsonInput = document.getElementById('jsonInput');
    
    // æœç´¢åŠŸèƒ½æ ¸å¿ƒå˜é‡
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    
    let musicList = []; // åŸå§‹å®Œæ•´æ­Œå•
    let filteredList = []; // æœç´¢è¿‡æ»¤åçš„æ­Œå•
    let currentMusicIndex = 0;
    let isPlaying = false;
    let animationId;

    // --- 1. æé€ŸåŠ è½½éŸ³ä¹æº (ä¼˜åŒ–ç‰ˆ) ---
    const musicJsonUrl = "https://13413.kstore.vip/QingMusic/music.json";
    
    // ä¼˜åŒ–ç­–ç•¥ï¼šè¶…æ—¶æ§åˆ¶ + é™çº§æç¤º
    const fetchWithTimeout = (url, timeout = 10000) => {
      return Promise.race([
        fetch(url).then(response => {
          if (!response.ok) throw new Error("ç½‘ç»œå“åº”å¼‚å¸¸");
          return response.json();
        }),
        new Promise((_, reject) => setTimeout(() => reject(new Error("è¯·æ±‚è¶…æ—¶")), timeout))
      ]);
    };

    // è‡ªåŠ¨åŠ è½½
    fetchWithTimeout(musicJsonUrl)
      .then(data => {
        handleLoadedData(data);
        initSearch(); // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
      })
      .catch(error => {
        console.error("è‡ªåŠ¨åŠ è½½å¤±è´¥ï¼š", error);
        btn.innerText = "åŠ è½½è¶…æ—¶ âŒ";
        musicNameEl.innerText = "è¯·ä½¿ç”¨é¡¶éƒ¨æ‰‹åŠ¨è¾“å…¥åŠŸèƒ½";
        emergencyBox.style.display = "block"; // æ˜¾ç¤ºå¤‡ç”¨æ–¹æ¡ˆ
      });

    // æ‰‹åŠ¨åŠ è½½ (ä¿åº•æ–¹æ¡ˆ)
    function loadFromText() {
      try {
        const jsonText = jsonInput.value.trim();
        if (!jsonText) return alert("è¯·å…ˆç²˜è´´JSONå†…å®¹ï¼");
        const data = JSON.parse(jsonText);
        handleLoadedData(data);
        initSearch(); // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
        emergencyBox.style.display = "none";
        alert("æ‰‹åŠ¨åŠ è½½æˆåŠŸï¼");
      } catch (e) {
        alert("JSONæ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥ï¼");
      }
    }

    // --- 2. å¤„ç†éŸ³ä¹æ•°æ® ---
    function handleLoadedData(data) {
      // å…¼å®¹ä¸¤ç§å¸¸è§æ ¼å¼ï¼š{list: [...]} æˆ– ç›´æ¥æ•°ç»„
      if (data.list && data.list.length > 0) {
        musicList = data.list;
      } else if (Array.isArray(data) && data.length > 0) {
        musicList = data;
      } else {
        throw new Error("æ­Œå•æ ¼å¼ä¸æ”¯æŒ");
      }
      
      filteredList = [...musicList]; // åˆå§‹åŒ–è¿‡æ»¤åˆ—è¡¨
      loadMusic(0);
      btn.innerText = `ç‚¹å‡»æ’­æ”¾ ${getName(0)}`;
    }

    // --- 3. æ’­æ”¾æ§åˆ¶æ ¸å¿ƒ ---
    function getName(index) {
      return filteredList[index]?.name || filteredList[index]?.title || "æœªçŸ¥æ­Œæ›²";
    }

    function loadMusic(index) {
      if (!filteredList.length) return;
      const song = filteredList[index];
      audioSource.src = song.url || song.path;
      audio.load(); // è§¦å‘åŠ è½½
      musicNameEl.innerText = `å½“å‰æ›²ç›®ï¼š${getName(index)}`;
      
      // ç¼“å†²æç¤º
      btn.innerText = "æ­£åœ¨ç¼“å†²...";
      audio.addEventListener('canplay', () => {
        if (!isPlaying) btn.innerText = `ç‚¹å‡»æ’­æ”¾ ${getName(index)}`;
      }, { once: true });
    }

    function toggleMusic() {
      if (!filteredList.length) return alert("æ­Œå•ä¸ºç©ºï¼");

      if (isPlaying) {
        audio.pause();
        btn.innerText = `ç‚¹å‡»æ’­æ”¾ ${getName(currentMusicIndex)}`;
        wave.classList.remove('active');
        cancelAnimationFrame(animationId);
      } else {
        audio.play().then(startPlaying).catch(err => {
          // æµè§ˆå™¨æ‹¦æˆªæ—¶çš„è§£é”é€»è¾‘
          btn.innerText = "ç‚¹å‡»å±å¹•ä»»æ„å¤„è§£é”";
          document.body.addEventListener('click', () => {
            audio.play().then(startPlaying);
          }, { once: true });
        });
      }
      isPlaying = !isPlaying;
    }

    function startPlaying() {
      btn.innerText = `æ­£åœ¨æ’­æ”¾... (ç‚¹å‡»æš‚åœ)`;
      wave.classList.add('active');
      simulateWave();
    }

    function switchMusic(type) {
      if (!filteredList.length) return;
      
      // åˆ‡æ¢æ—¶å…ˆæš‚åœåŠ¨ç”»
      if (isPlaying) {
        audio.pause();
        wave.classList.remove('active');
        cancelAnimationFrame(animationId);
        isPlaying = false;
      }

      // è®¡ç®—æ–°ç´¢å¼• (æ”¯æŒå¾ªç¯)
      currentMusicIndex = type === 'prev' 
        ? (currentMusicIndex - 1 + filteredList.length) % filteredList.length
        : (currentMusicIndex + 1) % filteredList.length;
      
      loadMusic(currentMusicIndex);
    }

    function simulateWave() {
      if (!isPlaying) return;
      const randomSize = Math.random() * 15 + 10;
      wave.style.boxShadow = `0 0 0 ${randomSize}px rgba(255, 51, 51, 0.5)`;
      animationId = requestAnimationFrame(simulateWave);
    }

    // --- 4. å¤´åƒå½©è›‹ ---
    avatarEl.onclick = function() {
      const tip = document.createElement('div');
      tip.innerText = 'ğŸ˜‹ å°å“¥å“¥';
      tip.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 30px;
        color: #ff3333;
        z-index: 999;
        animation: fade 2s ease-out;
      `;
      document.body.appendChild(tip);
      setTimeout(() => document.body.removeChild(tip), 2000);
    };

    // ====== æœç´¢åŠŸèƒ½æ ¸å¿ƒé€»è¾‘ (å®Œæ•´æ— åˆ å‡) ======
    function initSearch() {
      // å®æ—¶è¾“å…¥ç›‘å¬ (é˜²æŠ–ä¼˜åŒ–ï¼Œé¿å…é¢‘ç¹æ¸²æŸ“)
      let debounceTimer;
      searchInput.addEventListener('input', function(e) {
        clearTimeout(debounceTimer);
        const keyword = e.target.value.trim().toLowerCase();
        
        debounceTimer = setTimeout(() => {
          if (!keyword) {
            searchResults.classList.remove('show');
            filteredList = [...musicList]; // æ¸…ç©ºæœç´¢æ—¶æ¢å¤åŸæ­Œå•
            return;
          }

          // è¿‡æ»¤é€»è¾‘ï¼šåŒ¹é…æ­Œåæˆ–æ ‡é¢˜
          const results = musicList.filter(song => {
            const songName = (song.name || song.title || "").toLowerCase();
            return songName.includes(keyword);
          });

          // æ¸²æŸ“æœç´¢ç»“æœ
          renderSearchResults(results, keyword);
        }, 300); // 300msé˜²æŠ–ï¼Œæå‡æ€§èƒ½
      });

      // ç‚¹å‡»ç©ºç™½å¤„å…³é—­æœç´¢æ¡†
      document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
          searchResults.classList.remove('show');
        }
      });
    }

    // æ¸²æŸ“æœç´¢ç»“æœ (å¸¦å…³é”®è¯é«˜äº®)
    function renderSearchResults(results, keyword) {
      searchResults.classList.add('show');
      
      if (results.length === 0) {
        searchResults.innerHTML = '<div class="result-item" style="text-align:center;color:#666;">æ— åŒ¹é…æ­Œæ›²</div>';
        return;
      }

      // æ›´æ–°è¿‡æ»¤åˆ—è¡¨ï¼Œç”¨äºåˆ‡æ­Œ
      filteredList = results;
      currentMusicIndex = 0;

      // ç”Ÿæˆé«˜äº®HTML
      let html = '';
      results.forEach((song, index) => {
        let displayName = song.name || song.title || "æœªçŸ¥æ­Œæ›²";
        // é«˜äº®å…³é”®è¯
        const reg = new RegExp(keyword, 'gi');
        displayName = displayName.replace(reg, match => `<span class="highlight">${match}</span>`);
        
        html += `<div class="result-item" onclick="playSearchResult(${index})">${displayName}</div>`;
      });

      searchResults.innerHTML = html;
    }

    // ç‚¹å‡»æœç´¢ç»“æœæ’­æ”¾
    function playSearchResult(index) {
      currentMusicIndex = index;
      loadMusic(index);
      // è‡ªåŠ¨æ’­æ”¾
      audio.play().then(startPlaying).catch(() => {
        audio.play().then(startPlaying);
      });
      isPlaying = true;
      // å…³é—­æœç´¢æ¡†
      searchResults.classList.remove('show');
      searchInput.blur(); // æ”¶èµ·æ‰‹æœºé”®ç›˜
    }
  </script>
</body>
</html>
